<% meta og: { image: @event.passenger.photo_url(:facebook) } %>
<% meta og: { image:  { width: "1200", height: "630" } } %>

<div class="col-sm-5 ui-topleft">
  <%= link_to("#", onclick: 'showImage();') do %>
  <%= image_tag(@passenger.photo_url(:large), alt: 'Image'.to_s, id: 'passenger_image', style: 'display:none;') if @passenger.photo? %>
  <% end %>

<h3 class="text-uppercase wiggle" id="passenger_title"><%= t('passenger') %> <%= @passenger.name %> </h3>
<% unless @passenger.events.last.nil? || current_user == @passenger.events.last.user %>
  <%= submit_tag t('host'), :type => 'button', class: 'btn-default btn text-uppercase wiggle', id: 'contact', data: { toggle: 'modal', target: '#basicExampleModal' } %>
<% end %>
  <%= submit_tag t('photo'), :type => 'button', class: 'btn-default btn text-uppercase wiggle', id: 'photo', onclick: 'showImage();' %>
</div>

<div id="map"></div>
<script>
(function() {
  var $, cupcakeTiles;
  $ = jQuery;
  cupcakeTiles = L.tileLayer('https://api.mapbox.com/styles/v1/julesvau/cjkh85uud2eh22qruz2ylt7zq/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoianVsZXN2YXUiLCJhIjoiY2prNDd6NW5yMGFtOTNrbzQ5bWEweDgzbSJ9.-RD762orQSENzQ_f7TKU9g', {
  //cupcakeTiles = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_nolabels/{z}/{x}/{y}.png', {
    minZoom: 2,
    maxZoom: 18,
  });

  $.getJSON('<%= @passenger.id %>.json', function(data) {
    var geojson, map;
    var pointlist = [];

    geojson = L.geoJson(data, {
    onEachFeature: function(feature, layer) {
        layer.bindPopup(feature.properties.popupContent, {
          offset: new L.Point(10, -20),
           keepInView: true,
            showOnMouseOver: true,
            maxWidth: 500
          });

          layer.on('mouseover tap', function (e) {
              //Popup
              this.openPopup();
              //Change icon
              //e.target.setIcon(exampleiconHover);
          });

          layer.on('mouseout', function (e) {
              //Popup
            //  this.closePopup()
              //Change Icon
              //e.target.setIcon(exampleIcon);
          });
        var x = feature.geometry.coordinates[1];
        var y = feature.geometry.coordinates[0];
        pointlist.push([x, y]);

        if (layer.feature.properties.markerurl == null){
        layer.setIcon(new L.DivIcon({
        iconSize: new L.Point(64, 64),
        iconAnchor:[24, 24],
        className: "",
        html:'<p class="text-center"> <img src="'+layer.feature.properties.markerurl_fallback+'" class="img-marker img-circle '+layer.feature.properties.divclass+'">'+layer.feature.properties.title+'</p>'
        }));


       } else {
          layer.setIcon(new L.DivIcon({
          iconSize: new L.Point(64, 64),
          iconAnchor:[24, 24],
            className: "",
          html:'<p class="text-center"> <img src="'+layer.feature.properties.markerurl+'" class="img-marker img-circle '+layer.feature.properties.divclass+'">'+layer.feature.properties.title+'</p>'

          }));
            }
  }
});

function isEmpty(obj) {
    for(var key in obj) {
        if(obj.hasOwnProperty(key))
            return false;
    }
    return true;
}

if(isEmpty(geojson._layers)) {
  //console.log('layers sont vides');
  map = L.map('map').setView([30, 0], 2);
} else {
  //console.log('markers existent');
  map = L.map('map').fitBounds(geojson.getBounds());
}

    map.removeControl( map.zoomControl );
    cupcakeTiles.addTo(map);
    var markers = L.markerClusterGroup();
    var pathLine = L.polyline(pointlist, { dashArray: '1,5', color: '#000', weight: 1.3, opacity: 1, lineCap: 'square'}).addTo(map)
    markers.addLayer(geojson);
    markers.addTo(map);
    //console.log(markers._featureGroup._layers);
  });

}).call(this);
</script>
